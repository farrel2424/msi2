<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motorsights EPC â€” PDF Automation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg:         #f0f2f5;
            --surface:    #ffffff;
            --border:     #e2e5eb;
            --border-mid: #d0d5df;
            --text-1:     #0f1420;
            --text-2:     #4a5568;
            --text-3:     #8a94a6;
            --primary:    #2563eb;
            --primary-dk: #1d4ed8;
            --primary-lt: #eff6ff;
            --success:    #16a34a;
            --success-lt: #f0fdf4;
            --warning:    #d97706;
            --warning-lt: #fffbeb;
            --danger:     #dc2626;
            --danger-lt:  #fef2f2;
            --info:       #0284c7;
            --info-lt:    #f0f9ff;
            --accent:     #7c3aed;
            --radius:     10px;
            --radius-sm:  6px;
            --shadow:     0 1px 3px rgba(0,0,0,0.08), 0 4px 16px rgba(0,0,0,0.06);
            --shadow-sm:  0 1px 2px rgba(0,0,0,0.06);
            --mono:       'DM Mono', 'Consolas', monospace;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'DM Sans', system-ui, sans-serif;
            font-size: 15px;
            line-height: 1.6;
            background: var(--bg);
            color: var(--text-1);
            min-height: 100vh;
        }

        /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .page { max-width: 980px; margin: 0 auto; padding: 32px 20px 60px; }

        /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .site-header {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 28px 36px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .site-header__brand { display: flex; align-items: center; gap: 14px; }
        .site-header__icon {
            width: 44px; height: 44px;
            background: var(--primary);
            border-radius: 10px;
            display: grid; place-items: center;
            font-size: 22px;
            flex-shrink: 0;
        }
        .site-header__title {
            font-size: 20px; font-weight: 600; letter-spacing: -0.3px; color: var(--text-1);
        }
        .site-header__sub { font-size: 13px; color: var(--text-3); margin-top: 1px; }

        .site-header__right { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }

        .badge-sso {
            display: inline-flex; align-items: center; gap: 6px;
            background: var(--success-lt); color: var(--success);
            border: 1px solid #bbf7d0;
            padding: 5px 12px; border-radius: 20px;
            font-size: 12px; font-weight: 500;
        }

        nav { display: flex; gap: 4px; }
        nav a {
            padding: 7px 16px;
            border-radius: var(--radius-sm);
            font-size: 14px; font-weight: 500;
            color: var(--text-2);
            text-decoration: none;
            border: 1px solid transparent;
            transition: all 0.15s;
        }
        nav a:hover { background: var(--primary-lt); color: var(--primary); border-color: #bfdbfe; }
        nav a.active { background: var(--primary); color: #fff; }

        /* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 28px 32px;
            margin-bottom: 20px;
        }

        .card__header {
            display: flex; align-items: center; gap: 10px;
            font-size: 16px; font-weight: 600; color: var(--text-1);
            padding-bottom: 18px; margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        .card__header-icon { font-size: 18px; }

        /* â”€â”€ Info boxes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .info-box {
            display: flex; gap: 12px;
            padding: 14px 16px; border-radius: var(--radius-sm);
            font-size: 13.5px; line-height: 1.5;
            margin-bottom: 18px;
            border: 1px solid;
        }
        .info-box__icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
        .info-box--blue   { background: var(--info-lt);    border-color: #bae6fd; color: #0369a1; }
        .info-box--green  { background: var(--success-lt); border-color: #bbf7d0; color: #15803d; }
        .info-box--orange { background: var(--warning-lt); border-color: #fde68a; color: #92400e; }
        .info-box--purple { background: #faf5ff;           border-color: #e9d5ff; color: #6b21a8; }
        .info-box code {
            font-family: var(--mono); font-size: 12px;
            background: rgba(0,0,0,0.07); padding: 1px 5px; border-radius: 3px;
        }

        /* â”€â”€ Forms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }

        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block; margin-bottom: 6px;
            font-size: 13.5px; font-weight: 500; color: var(--text-2);
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-mid);
            border-radius: var(--radius-sm);
            font-size: 14px; font-family: inherit;
            background: var(--surface);
            color: var(--text-1);
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.12);
        }
        .form-group textarea { font-family: var(--mono); font-size: 13px; min-height: 160px; resize: vertical; }
        .form-group small { display: block; margin-top: 5px; font-size: 12px; color: var(--text-3); }

        /* â”€â”€ Credentials collapsible â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .credentials-details {
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 18px;
            overflow: hidden;
        }
        .credentials-details summary {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 13.5px; font-weight: 500; color: var(--text-2);
            background: #fafbfc;
            user-select: none;
            list-style: none;
            display: flex; align-items: center; gap: 8px;
        }
        .credentials-details summary::-webkit-details-marker { display: none; }
        .credentials-details summary::before { content: 'â€º'; font-size: 18px; transition: transform 0.2s; }
        .credentials-details[open] summary::before { transform: rotate(90deg); }
        .credentials-details summary:hover { background: var(--primary-lt); color: var(--primary); }
        .credentials-content { padding: 18px 16px; border-top: 1px solid var(--border); }
        .credentials-content h4 { font-size: 13px; font-weight: 500; color: var(--text-3); margin: 12px 0 10px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* â”€â”€ Partbook type badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .partbook-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 14px; border-radius: 20px;
            font-size: 13px; font-weight: 500;
            border: 1px solid;
        }
        .badge-engine        { background: var(--success-lt); color: var(--success);  border-color: #bbf7d0; }
        .badge-transmission  { background: var(--primary-lt); color: var(--primary);  border-color: #bfdbfe; }
        .badge-cabin_chassis { background: var(--warning-lt); color: var(--warning);  border-color: #fde68a; }
        .badge-axle_drive    { background: #faf5ff;           color: var(--accent);   border-color: #e9d5ff; }

        /* â”€â”€ Upload area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .upload-area {
            border: 2px dashed var(--border-mid);
            border-radius: var(--radius);
            padding: 52px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafbfc;
            margin-top: 18px;
        }
        .upload-area:hover { border-color: var(--primary); background: var(--primary-lt); }
        .upload-area.dragover { border-color: var(--primary); background: var(--primary-lt); transform: scale(1.01); }
        .upload-area__icon { font-size: 40px; margin-bottom: 14px; }
        .upload-area__text { font-size: 15px; font-weight: 500; color: var(--text-1); margin-bottom: 4px; }
        .upload-area__sub  { font-size: 13px; color: var(--text-3); }
        #fileInput { display: none; }

        /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn {
            display: inline-flex; align-items: center; gap: 7px;
            padding: 9px 18px;
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            font-size: 14px; font-weight: 500; font-family: inherit;
            cursor: pointer; text-decoration: none;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .btn--primary { background: var(--primary); color: #fff; border-color: var(--primary); }
        .btn--primary:hover { background: var(--primary-dk); border-color: var(--primary-dk); }
        .btn--success { background: var(--success); color: #fff; border-color: var(--success); }
        .btn--success:hover { background: #15803d; }
        .btn--warning { background: var(--warning); color: #fff; border-color: var(--warning); }
        .btn--warning:hover { background: #b45309; }
        .btn--ghost { background: transparent; color: var(--text-2); border-color: var(--border-mid); }
        .btn--ghost:hover { background: var(--bg); }
        .btn:disabled { opacity: 0.45; cursor: not-allowed; }

        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; }

        /* â”€â”€ Status panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .status-panel {
            background: #fafbfc;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 20px;
            margin-top: 18px;
        }
        .status-panel__title { font-size: 14px; font-weight: 600; color: var(--text-2); margin-bottom: 14px; }

        .status-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 9px 0; border-bottom: 1px solid var(--border);
            font-size: 13.5px;
        }
        .status-row:last-of-type { border-bottom: none; }
        .status-row__label { color: var(--text-3); font-weight: 500; }

        .status-badge {
            display: inline-flex; align-items: center;
            padding: 3px 10px; border-radius: 20px;
            font-size: 12px; font-weight: 600; letter-spacing: 0.2px;
        }
        .status-queued       { background: #fef9c3; color: #713f12; }
        .status-processing   { background: var(--primary-lt); color: var(--primary); }
        .status-pending_review { background: var(--warning-lt); color: var(--warning); }
        .status-submitting   { background: #faf5ff; color: var(--accent); }
        .status-completed    { background: var(--success-lt); color: var(--success); }
        .status-failed,
        .status-error        { background: var(--danger-lt); color: var(--danger); }

        /* â”€â”€ Progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .progress { height: 5px; background: var(--border); border-radius: 3px; margin-top: 14px; overflow: hidden; }
        .progress__fill {
            height: 100%; background: var(--primary);
            border-radius: 3px; transition: width 0.4s ease;
        }

        /* â”€â”€ JSON editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .json-editor {
            width: 100%; min-height: 380px; max-height: 560px;
            background: #0f1420; color: #e2e8f0;
            padding: 18px; border-radius: var(--radius-sm);
            font-family: var(--mono); font-size: 13px; line-height: 1.6;
            border: 1px solid var(--border);
            resize: vertical; tab-size: 2; white-space: pre;
            overflow: auto; display: block;
        }
        .json-editor:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.12); }

        /* â”€â”€ Section heading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .section-title {
            font-size: 15px; font-weight: 600; color: var(--text-1);
            margin: 22px 0 14px;
            display: flex; align-items: center; gap: 8px;
        }

        /* â”€â”€ Alerts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .alert {
            display: flex; gap: 10px; align-items: flex-start;
            padding: 12px 16px; border-radius: var(--radius-sm);
            font-size: 13.5px; margin-bottom: 16px; border: 1px solid;
        }
        .alert--success { background: var(--success-lt); border-color: #bbf7d0; color: #15803d; }
        .alert--error   { background: var(--danger-lt);  border-color: #fecaca; color: var(--danger); }
        .alert--warning { background: var(--warning-lt); border-color: #fde68a; color: #92400e; }
        .alert--info    { background: var(--info-lt);    border-color: #bae6fd; color: var(--info); }

        /* â”€â”€ Submission summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .submission-summary {
            background: var(--success-lt); border: 1px solid #bbf7d0;
            border-radius: var(--radius-sm); padding: 16px; margin-top: 12px;
        }
        .submission-summary__title { font-weight: 600; color: var(--success); margin-bottom: 10px; font-size: 14px; }
        .summary-row {
            display: flex; justify-content: space-between;
            padding: 5px 0; font-size: 13.5px; border-bottom: 1px solid #d1fae5;
        }
        .summary-row:last-child { border-bottom: none; }
        .summary-row__label { color: var(--text-2); }
        .summary-row__value { font-weight: 600; }
        .summary-row__value--created { color: var(--success); }
        .summary-row__value--skipped { color: var(--warning); }
        .summary-row__value--error   { color: var(--danger); }

        /* â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .hidden { display: none !important; }
        .mt-4 { margin-top: 16px; }
        .text-sm { font-size: 13px; color: var(--text-3); }
    </style>
</head>
<body>
<div class="page">

    <!-- Header -->
    <header class="site-header">
        <div class="site-header__brand">
            <div class="site-header__icon">ğŸšš</div>
            <div>
                <div class="site-header__title">Motorsights EPC</div>
                <div class="site-header__sub">Electronic Product Catalog â€” PDF Automation</div>
            </div>
        </div>
        <div class="site-header__right">
            <span class="badge-sso">ğŸ” SSO Active</span>
            <nav>
                <a href="/" class="active">Upload</a>
                <a href="/history">History</a>
            </nav>
        </div>
    </header>

    <!-- Upload & Extract Card -->
    <div class="card">
        <div class="card__header">
            <span class="card__header-icon">ğŸ“¤</span>
            Upload &amp; Extract
        </div>

        <div id="alertContainer"></div>

        <div class="info-box info-box--blue">
            <span class="info-box__icon">â„¹ï¸</span>
            <div><strong>Workflow:</strong> Upload PDF â†’ AI Extraction â†’ Review &amp; Edit â†’ Approve â†’ Submit to Database</div>
        </div>

        <!-- Credentials -->
        <details class="credentials-details">
            <summary>ğŸ”‘ API Credentials (optional â€” defaults to .env)</summary>
            <div class="credentials-content">
                <div class="form-group">
                    <label>Sumopod API Key</label>
                    <input type="password" id="sumopodApiKey" placeholder="sk-... (leave empty to use .env)">
                    <small>Only required if not set in .env</small>
                </div>
                <h4>SSO Credentials</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="ssoEmail" placeholder="user@motorsights.net">
                        <small>Required for bearer token generation</small>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="ssoPassword" placeholder="Leave empty to use .env">
                    </div>
                </div>
            </div>
        </details>

        <!-- Main config -->
        <div class="form-row">
            <div class="form-group">
                <label>Master Category <span style="color:var(--danger)">*</span></label>
                <select id="masterCategory" onchange="onMasterCategoryChange()" required>
                    <option value="">Select Master Categoryâ€¦</option>
                </select>
                <small>Determines extraction strategy</small>
            </div>
            <div class="form-group">
                <label>AI Model <span style="color:var(--danger)">*</span></label>
                <select id="aiModel" required>
                    <option value="gpt-4o">GPT-4o â€” Best Quality</option>
                    <option value="claude-3-5-sonnet">Claude 3.5 Sonnet â€” High Quality</option>
                    <option value="claude-3-5-haiku">Claude 3.5 Haiku â€” Fast</option>
                    <option value="gpt-4-turbo">GPT-4 Turbo â€” Legacy</option>
                </select>
            </div>
        </div>

        <!-- Partbook strategy badge -->
        <div class="form-group hidden" id="partbookBadgeGroup">
            <label>Extraction Strategy</label>
            <div class="mt-4">
                <span class="partbook-badge" id="partbookBadge"></span>
            </div>
        </div>

        <!-- Cabin & Chassis prompt -->
        <div class="form-group" id="promptGroup">
            <label>Extraction Prompt</label>
            <textarea id="extractionPrompt">You are a data extraction expert for Electronic Product Catalogs (EPC). Extract structured information from PDF markdown text.

**CRITICAL: Extract data in the EXACT format shown below - NO codes required!**

PDF Structure Pattern:
```
10          Frame System è½¦æ¶ç³»ç»Ÿ                                    1
D C97259880020   Front Accessories ä¸­ä¿é™©æ ...                        ...4
D C95259510002   Transmission Auxiliary Crossbeam å˜é€Ÿå™¨è¾…åŠ©æ¨ªæ¢...     ...6
```

Rules:
1. Section headers (number + bold text) = Category
2. Part entries (after header) = Type Categories â€” include the part code in the English name
3. Return ONLY valid JSON, no markdown, no explanations

OUTPUT FORMAT:
{
  "categories": [
    {
      "category_name_en": "string",
      "category_name_cn": "string",
      "data_type": [
        {
          "type_category_name_en": "string",
          "type_category_name_cn": "string",
          "type_category_description": "string"
        }
      ]
    }
  ]
}

Do NOT include type_category_code or categories_code.</textarea>
            <small>Applies only to Cabin &amp; Chassis extractions</small>
        </div>

        <!-- Engine note -->
        <div class="form-group hidden" id="engineNoteGroup">
            <div class="info-box info-box--green">
                <span class="info-box__icon">âœ‚ï¸</span>
                <div><strong>Engine mode:</strong> Crops the top-right corner of each page to read the bilingual category label (e.g. <code>ç¼¸ä½“ç®¡è·¯PLUMBING,CYLINDER BLOCK</code>). Uses zero AI tokens. Duplicates are skipped automatically.</div>
            </div>
        </div>

        <!-- Transmission note -->
        <div class="form-group hidden" id="transmissionNoteGroup">
            <div class="info-box info-box--orange">
                <span class="info-box__icon">ğŸ“‹</span>
                <div><strong>Transmission mode:</strong> Extracts the Chinese-only Table of Contents from the first pages and translates all category names to English in a single AI call.</div>
            </div>
        </div>

        <!-- Axle Drive note -->
        <div class="form-group hidden" id="axleDriveNoteGroup">
            <div class="info-box info-box--purple">
                <span class="info-box__icon">ğŸ”</span>
                <div><strong>Axle Drive mode:</strong> Identifies table pages via manifest.json, then uses AI vision to read each table title. Produces one Category with N Type Categories.<br><small style="opacity:.8">1 vision call per table page + 1 translation call</small></div>
            </div>
        </div>

        <!-- Upload dropzone -->
        <div class="upload-area" id="uploadArea">
            <div class="upload-area__icon">ğŸ“</div>
            <div class="upload-area__text">Drag &amp; drop your PDF catalog here</div>
            <div class="upload-area__sub">or click to browse files</div>
            <input type="file" id="fileInput" accept=".pdf">
        </div>
    </div><!-- /card -->

    <!-- Status & Review Card -->
    <div class="card hidden" id="statusCard">
        <div class="card__header">
            <span class="card__header-icon">ğŸ“Š</span>
            Processing Status
        </div>

        <div class="status-panel">
            <div class="status-panel__title">Current Job</div>
            <div class="status-row">
                <span class="status-row__label">File</span>
                <span id="statusFilename">â€”</span>
            </div>
            <div class="status-row">
                <span class="status-row__label">Type</span>
                <span id="statusPartbookType">â€”</span>
            </div>
            <div class="status-row">
                <span class="status-row__label">Status</span>
                <span id="statusBadge">â€”</span>
            </div>
            <div class="status-row">
                <span class="status-row__label">Stage</span>
                <span id="statusStage">â€”</span>
            </div>
            <div class="progress">
                <div class="progress__fill" id="progressFill" style="width:0%"></div>
            </div>
        </div>

        <!-- Review & Edit -->
        <div class="hidden" id="reviewSection">
            <div class="section-title">ğŸ“ Review &amp; Edit Extracted Data</div>
            <p class="text-sm" style="margin-bottom:14px;">Edit the JSON below before submitting. Duplicate categories are automatically skipped â€” no need to remove them.</p>

            <textarea class="json-editor" id="jsonEditor" spellcheck="false"></textarea>

            <div class="btn-group">
                <button class="btn btn--ghost" id="downloadBtn">ğŸ’¾ Download JSON</button>
                <button class="btn btn--warning" id="reExtractBtn">ğŸ”„ Re-Extract</button>
                <button class="btn btn--success" id="approveBtn">âœ… Approve &amp; Submit</button>
            </div>
        </div>

        <!-- Submission result -->
        <div class="hidden" id="submissionResult"></div>

        <!-- Re-prompt -->
        <div class="hidden" id="rePromptSection">
            <div class="section-title">ğŸ”„ Re-Extract with Modified Prompt</div>
            <div class="form-group">
                <label>Modified Extraction Prompt</label>
                <textarea id="rePromptText" style="min-height:180px;font-family:var(--mono);font-size:13px;"></textarea>
            </div>
            <div class="btn-group">
                <button class="btn btn--ghost" id="cancelRePrompt">Cancel</button>
                <button class="btn btn--warning" id="confirmRePrompt">Start Re-Extraction</button>
            </div>
        </div>
    </div><!-- /statusCard -->

</div><!-- /page -->

<script>
    const uploadArea      = document.getElementById('uploadArea');
    const fileInput       = document.getElementById('fileInput');
    const statusCard      = document.getElementById('statusCard');
    const alertContainer  = document.getElementById('alertContainer');
    const reviewSection   = document.getElementById('reviewSection');
    const rePromptSection = document.getElementById('rePromptSection');
    const jsonEditor      = document.getElementById('jsonEditor');

    let currentJobId    = null;
    let statusInterval  = null;
    let editorPopulated = false;

    const PROGRESS_MAP = {
        queued: 5, processing: 25, extracting: 60,
        pending_review: 90, submitting: 95,
        completed: 100, error: 100, failed: 100
    };

    const PARTBOOK_META = {
        engine:       { label: 'âš™ï¸ Engine â€” Top-Right Crop (0 AI tokens)', cls: 'badge-engine' },
        transmission: { label: 'ğŸ”§ Transmission â€” ToC Translation (1 AI call)', cls: 'badge-transmission' },
        cabin_chassis:{ label: 'ğŸš› Cabin & Chassis â€” Full Markdown Extraction', cls: 'badge-cabin_chassis' },
        axle_drive:   { label: 'ğŸ› Axle Drive â€” Vision Extraction (1 call/page)', cls: 'badge-axle_drive' }
    };

    // â”€â”€ Master categories â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadMasterCategories() {
        try {
            const { categories } = await fetch('/api/master-categories').then(r => r.json());
            const select = document.getElementById('masterCategory');
            select.innerHTML = '<option value="">Select Master Categoryâ€¦</option>';
            categories.forEach(cat => {
                const opt = new Option(`${cat.name_en} / ${cat.name_cn}`, cat.id);
                opt.dataset.partbookType = cat.partbook_type || 'cabin_chassis';
                select.add(opt);
            });
            if (!categories.length) showAlert('No master categories configured. Set UUIDs in .env.', 'warning');
        } catch (err) {
            showAlert('Failed to load master categories: ' + err.message, 'error');
        }
    }

    function onMasterCategoryChange() {
        const sel   = document.getElementById('masterCategory');
        const ptype = sel.options[sel.selectedIndex]?.dataset.partbookType || '';
        const meta  = PARTBOOK_META[ptype];

        const badgeGroup = document.getElementById('partbookBadgeGroup');
        const badge      = document.getElementById('partbookBadge');
        if (meta) {
            badge.textContent = meta.label;
            badge.className   = 'partbook-badge ' + meta.cls;
            badgeGroup.classList.remove('hidden');
        } else {
            badgeGroup.classList.add('hidden');
        }

        document.getElementById('promptGroup').classList.toggle('hidden', ptype !== 'cabin_chassis' && ptype !== '');
        document.getElementById('engineNoteGroup').classList.toggle('hidden', ptype !== 'engine');
        document.getElementById('transmissionNoteGroup').classList.toggle('hidden', ptype !== 'transmission');
        document.getElementById('axleDriveNoteGroup').classList.toggle('hidden', ptype !== 'axle_drive');
    }

    // â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

    function handleFile(file) {
        if (!file.name.toLowerCase().endsWith('.pdf')) { showAlert('Please select a PDF file.', 'error'); return; }
        const mc = document.getElementById('masterCategory').value;
        if (!mc) { showAlert('Please select a Master Category first.', 'error'); return; }
        uploadFile(file, mc, document.getElementById('aiModel').value, document.getElementById('extractionPrompt').value);
    }

    async function uploadFile(file, masterCategoryId, aiModel, prompt) {
        const fd = new FormData();
        fd.append('file', file);
        fd.append('master_category_id', masterCategoryId);
        fd.append('ai_model', aiModel);
        fd.append('custom_prompt', prompt);

        const key = document.getElementById('sumopodApiKey').value.trim();
        const em  = document.getElementById('ssoEmail').value.trim();
        const pw  = document.getElementById('ssoPassword').value.trim();
        if (key) fd.append('sumopod_api_key', key);
        if (em)  fd.append('sso_email', em);
        if (pw)  fd.append('sso_password', pw);

        try {
            const resp = await fetch('/api/upload', { method: 'POST', body: fd });
            const data = await resp.json();
            if (resp.ok) {
                currentJobId    = data.job_id;
                editorPopulated = false;
                showAlert('File uploaded. Processing startedâ€¦', 'success');
                statusCard.classList.remove('hidden');
                reviewSection.classList.add('hidden');
                rePromptSection.classList.add('hidden');
                document.getElementById('submissionResult').classList.add('hidden');
                startPolling();
            } else {
                showAlert('Upload failed: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (err) {
            showAlert('Network error: ' + err.message, 'error');
        }
    }

    // â”€â”€ Status polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startPolling() {
        if (statusInterval) clearInterval(statusInterval);
        statusInterval = setInterval(checkStatus, 2000);
        checkStatus();
    }

    function stopPolling() {
        clearInterval(statusInterval);
        statusInterval = null;
    }

    async function checkStatus() {
        if (!currentJobId) return;
        try {
            const resp = await fetch('/api/status/' + currentJobId);
            if (!resp.ok) return;
            const job = await resp.json();
            renderStatus(job);
            if (['completed', 'error', 'failed'].includes(job.status)) stopPolling();
            if (job.status === 'pending_review' && !editorPopulated) openReview(job);
        } catch (err) {
            console.error('Status check error:', err);
        }
    }

    function renderStatus(job) {
        document.getElementById('statusFilename').textContent = job.filename || 'â€”';
        document.getElementById('statusPartbookType').textContent =
            job.partbook_type ? (PARTBOOK_META[job.partbook_type]?.label || job.partbook_type) : 'â€”';
        document.getElementById('statusStage').textContent = job.stage || 'â€”';
        document.getElementById('statusBadge').innerHTML =
            `<span class="status-badge status-${job.status}">${job.status.replace('_', ' ').toUpperCase()}</span>`;
        document.getElementById('progressFill').style.width = (PROGRESS_MAP[job.status] || 0) + '%';
        if (job.status === 'error' || job.status === 'failed') {
            showAlert('Error: ' + (job.error || 'Unknown error'), 'error');
            stopPolling();
        }
    }

    function openReview(job) {
        if (!job.extracted_data) return;
        editorPopulated = true;
        stopPolling();
        jsonEditor.value = JSON.stringify(job.extracted_data, null, 2);
        reviewSection.classList.remove('hidden');
        document.getElementById('rePromptText').value = document.getElementById('extractionPrompt').value;
        showAlert('Extraction complete. Review the data below, then approve to submit.', 'success');
    }

    // â”€â”€ Download JSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('downloadBtn').addEventListener('click', () => {
        try {
            const data = JSON.parse(jsonEditor.value);
            const url  = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
            Object.assign(document.createElement('a'), { href: url, download: `extracted_${currentJobId}.json` }).click();
            URL.revokeObjectURL(url);
        } catch { showAlert('Invalid JSON â€” fix syntax errors before downloading.', 'error'); }
    });

    // â”€â”€ Re-Extract â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('reExtractBtn').addEventListener('click', () => rePromptSection.classList.remove('hidden'));
    document.getElementById('cancelRePrompt').addEventListener('click', () => rePromptSection.classList.add('hidden'));

    document.getElementById('confirmRePrompt').addEventListener('click', async () => {
        const newPrompt = document.getElementById('rePromptText').value.trim();
        if (!newPrompt) { showAlert('Please enter a prompt first.', 'error'); return; }

        try {
            const resp = await fetch('/api/re-extract/' + currentJobId, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: newPrompt })
            });
            if (resp.ok) {
                editorPopulated = false;
                showAlert('Re-extraction startedâ€¦', 'info');
                rePromptSection.classList.add('hidden');
                reviewSection.classList.add('hidden');
                startPolling();
            } else {
                const d = await resp.json();
                showAlert((d.error || 'Re-extraction failed'), 'error');
            }
        } catch (err) { showAlert('Network error: ' + err.message, 'error'); }
    });

    // â”€â”€ Approve & Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('approveBtn').addEventListener('click', async () => {
        if (!confirm('Submit to EPC database?\n\nDuplicate categories will be skipped automatically.')) return;

        let editedData;
        try { editedData = JSON.parse(jsonEditor.value); }
        catch { showAlert('Invalid JSON â€” fix syntax errors before submitting.', 'error'); return; }

        showAlert('Submitting to EPCâ€¦', 'info');

        try {
            const resp   = await fetch('/api/approve/' + currentJobId, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: editedData })
            });
            const result = await resp.json();
            if (resp.ok && result.success) renderSubmissionResult(result.epc_results);
            else showAlert('Submission failed: ' + (result.error || 'Unknown error'), 'error');
        } catch (err) { showAlert('Network error: ' + err.message, 'error'); }
    });

    function renderSubmissionResult(r) {
        const created  = r.categories_created?.length  || 0;
        const skipped  = r.categories_skipped?.length  || 0;
        const typeCats = r.type_categories_created?.length || 0;
        const errors   = r.errors?.length || 0;

        const el = document.getElementById('submissionResult');
        el.classList.remove('hidden');
        el.innerHTML = `
            <div class="submission-summary">
                <div class="submission-summary__title">âœ… Submission Complete</div>
                <div class="summary-row"><span class="summary-row__label">Categories Created</span><span class="summary-row__value summary-row__value--created">${created}</span></div>
                <div class="summary-row"><span class="summary-row__label">Skipped (duplicates)</span><span class="summary-row__value summary-row__value--skipped">${skipped}</span></div>
                ${typeCats ? `<div class="summary-row"><span class="summary-row__label">Type Categories Created</span><span class="summary-row__value summary-row__value--created">${typeCats}</span></div>` : ''}
                ${errors   ? `<div class="summary-row"><span class="summary-row__label">Errors</span><span class="summary-row__value summary-row__value--error">${errors}</span></div>` : ''}
            </div>`;

        showAlert(
            errors ? `Completed with ${errors} error(s). Check summary.` :
                     `Done! ${created} new, ${skipped} skipped${typeCats ? `, ${typeCats} type categories` : ''}.`,
            errors ? 'warning' : 'success'
        );
    }

    // â”€â”€ Alert utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showAlert(message, type = 'info') {
        const div = document.createElement('div');
        div.className = `alert alert--${type}`;
        div.textContent = message;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(div);
        setTimeout(() => div.remove(), 10000);
    }

    window.addEventListener('load', loadMasterCategories);
</script>
</body>
</html>